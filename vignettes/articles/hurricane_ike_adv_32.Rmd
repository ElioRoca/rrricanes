---
title: "Hurricane Ike, Adv #32"
author: "Tim Trice"
date: "June 11, 2017"
output: html_document
references:
- id: sshws
  title: The Saffir-Simpson Hurricane Wind Scale
  author:
  - family: Schott
    given: Timothy
  - family: Landsea
    given: Chris
  - family: Hafele
    given: Gene
  - family: Lorens
    given: Jeffrey
  - family: Taylor
    given: Arthur
  - family: Thurm
    given: Harvey
  - family: Ward
    given: Bill
  - family: Willis
    given: Mark
  - family: Zaleski
    given: WAlt
  URL: 'http://www.nhc.noaa.gov/pdf/sshws.pdf'
  page: 2
  issued:
    year: 2012
    month: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      fig.width = 10, 
                      fig.asp = 1, 
                      fig.align = "center")
```

```{r, message = FALSE}
library(dplyr)
library(gganimate)
library(ggplot2)
library(HURDAT)
library(purrr)
library(rrricanes)
library(tibble)
library(tidyr)
library(sp)
```

## Obtaining Data

```{r}
key <- "AL092008"
adv <- 42
```

### Forecast/Advisory Data for Hurricane Ike

```{r}
# No need to do this piece for active storms
fstadv <- load_storm_data("fstadv") %>% filter(Key == key, Adv <= adv)
```

### GIS Advisory Forecast Track, Cone of Uncertainty, and Watches/Warnings

```{r}
gis_adv <- gis_advisory(key = key, advisory = adv) %>% gis_download()
```

Get bounding box of the forecast polygon.

```{r}
bbox <- bbox(gis_adv$al092008_042_5day_pgn)
```

### Probabilistic Storm Surge

Calculate the last date/time of forecast/advisory product and subtract 3 hrs

```{r}
dt <- (last(fstadv$Date) - (60 * 60 * 3)) %>% 
    strftime(format = "%Y%m%d%H", tz = "UTC")
```

Wrap `gis_download` in `safely`. Not all products will exist for every storm or even every advisory. 

```{r}
dl <- purrr::safely(.f = gis_download)
gis_surge <- gis_prob_storm_surge(key, products = list("psurge" = c(5)), 
                                  datetime = dt) %>% dl()

if (!is.null(gis_surge$error))
    message(gis_surge$error)
```

## Build a Tracking Chart

Generate a base plot of the Atlantic ocean.

```{r}
bp <- al_tracking_chart(color = "black", fill = "white", size = 0.1, res = 50)
```

I like to add a little cushion for the map inset and forecast cone data. 

```{r}
lat_min <- bbox[2,1] - 5
lat_max <- bbox[2,2] + 5
lon_min <- bbox[1,1] - 10
lon_max <- bbox[1,2] + 10
```

Build a thin tracking map for the inset.

```{r}
bp_inset <- ggplotGrob(bp +
    geom_rect(mapping = aes(xmin = lon_min, xmax = lon_max,
                            ymin = lat_min, ymax = lat_max),
              color = "red", alpha = 0) +
    theme_bw() +
    theme(axis.title = element_blank(),
          axis.ticks = element_blank(),
          axis.text.x = element_blank(),
          axis.text.y = element_blank(),
          plot.margin = margin(0, 0, 0, 0, "pt")))
```

Modify original `bp` zoomed in on our area of interest.

```{r}
bp <- bp +
    coord_equal(xlim = c(lon_min, lon_max),
                ylim = c(lat_min, lat_max)) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    labs(x = "Lon",
         y = "Lat",
         caption = sprintf("rrricanes %s", packageVersion("rrricanes")))
```

Combine `bp` and `bp_inset` to finalize initial base plot. `bp` will be a base plot without the inset. `bpi` will have the inset.

```{r}
bpi <- bp + annotation_custom(grob = bp_inset, xmin = lon_max - 5,
                             xmax = lon_max - 1, ymin = -Inf,
                             ymax = lat_min + 5)
```

## Current Advisory Details

Lines and Polygons spatial dataframes can be helpfully converted using `shp_to_df`. The original spatial dataframes can be plotted directly in `ggplot2` but, to my understanding, access to the other variables are not available.

```{r}
# Convert object SpatialLinesDataframe to dataframe
shp_storm_lin <- shp_to_df(gis_adv$al092008_042_5day_lin)
shp_storm_ww <- shp_to_df(gis_adv$al092008_042_ww_wwlin)
# Convert object SpatialPolygonsDataframe to dataframe
shp_storm_pgn <- shp_to_df(gis_adv$al092008_042_5day_pgn)
shp_storm_surge <- shp_to_df(gis_surge$result$al092008_2008091112_gt5) 
```

Points dataframes can just be converted with `tibble::as_data_frame`. 

```{r}
# Convert object SpatialPointsDataframe to dataframe
shp_storm_pts <- as_data_frame(gis_adv$al092008_042_5day_pts)
```

Modify `shp_storm_pts$DVLBL` with full strings and ordered factor.

```{r}
shp_storm_pts$DVLBL <- factor(shp_storm_pts$DVLBL, 
                              levels = c("D", "S", "H"), 
                              labels = c("Tropical Depression", 
                                         "Tropical Storm", 
                                         "Hurricane"))
```

Same with `shp_storm_pts$TCWW`:

```{r}
shp_storm_ww$TCWW <- factor(shp_storm_ww$TCWW, 
                              levels = c("TWA", "TWR", "HWA", "HWR"), 
                              labels = c("Tropical Storm Watch", 
                                         "Tropical Storm Warning", 
                                         "Hurricane Watch", 
                                         "Hurricane Warning"))
```

```{r}
bpi + geom_polygon(data = shp_storm_pgn, 
                  aes(x = long, y = lat, group = group),
                  alpha = 0.15, fill = "orange") + 
    geom_path(data = shp_storm_lin, aes(x = long, y = lat, group = group)) + 
    geom_point(data = shp_storm_pts, aes(x = LON, y = LAT, fill = DVLBL,
                                         shape = DVLBL, size = MAXWIND)) + 
    geom_path(data = shp_storm_ww, aes(x = long, y = lat, color = TCWW, 
                                       group = group), size = 1) + 
    scale_shape_manual(values = c(21, 21, 21, 21)) + 
    guides(shape = guide_legend(override.aes = list(size = 3)), 
           size = guide_legend(nrow = 1)) + 
    theme(legend.position = "bottom", 
          legend.box = "vertical")
```

Very often, areas that are under a hurricane watch may also be under a tropical storm warning. The chart above does not show the hurricane watch area.

## Wind Speed Probabilities

```{r}
wndprb <- load_storm_data("wndprb") %>% filter(Key == key, Adv <= adv)
```

The `wndprb` will not have coordinates for cities. An option is `al_prblty_stations`. However, please note this function may become [deprecated](https://github.com/timtrice/rrricanes/issues/46). 

```{r}
wndprb <- wndprb %>% 
    left_join(al_prblty_stations(), by = "Location")
```

Check `wndprb` for NA values in `Lat`, `Lon`.

```{r}
any(is.na(wndprb$Lat), is.na(wndprb$Lon))
```

A fall back is to get breakpoints shapefile for the year. However, this will not have all of the locations listed in the `wndprb` products.

```{r}
breakpoints <- gis_breakpoints(year = 2008) %>% gis_download()
```

```{r}
breakpoints <- as_data_frame(breakpoints$Breakpoints_2008)
```

```{r}
bp +
    geom_point(data = wndprb %>% filter(Adv == adv, Wind <= 64), 
               aes(x = Lon, y = Lat, color = Wind120Cum, size = Wind120Cum)) + 
    scale_color_gradientn(colors = terrain.colors(10)) + 
    coord_equal(xlim = c(min(wndprb$Lon) - 1, 
                         max(wndprb$Lon) + 1),
                # Account for extra padding of min Lat in original plot
                ylim = c(min(wndprb$Lat) + 2, 
                         max(wndprb$Lat) + 1)) + 
    guides(size = FALSE) + 
    theme(legend.position = "bottom", 
          legend.box = "vertical") + 
    labs(title = "Total Probability of Wind >= 64kts within 120 Hours")
```

## Probabilistic Storm Surge

Probability of storm surge greater than five feet.

```{r}
bp + geom_point(data = shp_storm_surge, 
                aes(x = long, y = lat, color = ProbSurge05), size = 1) + 
    coord_equal(xlim = c(min(shp_storm_surge$long) - 1, 
                         max(shp_storm_surge$long) + 1), 
                ylim = c(min(shp_storm_surge$lat) - 1, 
                         max(shp_storm_surge$lat) + 1)) + 
    theme(legend.position = "bottom", 
          legend.box = "vertical") +
    labs(title = "Probabilistic Storm Surge > 5ft", 
         caption = sprintf("rrricanes %s", packageVersion("rrricanes")))
```

## Wind and Pressure Details

### Wind Profile

```{r, fig.width = 5}
# Plot wind values
fstadv %>% ggplot(aes(x = Date, y = Wind)) + 
    geom_line() + 
    geom_point(aes(color = Status), size = 3) + 
    scale_y_continuous(name = "Wind (kts)") + 
    theme_bw() + 
    theme(legend.position = "bottom", 
          legend.box = "vertical") +
    labs(title = "Wind Profile", 
         caption = sprintf("rrricanes %s", packageVersion("rrricanes")))
```

### Pressure Profile

```{r, fig.width = 5}
# Plot pressure values
fstadv %>% ggplot(aes(x = Date, y = Pressure)) + 
    geom_line() + 
    geom_point(aes(color = Status), size = 3) + 
    scale_y_continuous(name = "Pressure (mb)") + 
    theme_bw() + 
    theme(legend.position = "bottom", 
          legend.box = "vertical") +
    labs(title = "Pressure Profile", 
         caption = sprintf("rrricanes %s", packageVersion("rrricanes")))
```

### Wind/Pressure Relational Change

```{r, fig.width = 5}
fstadv %>%
    mutate(WindDist = (Wind - min(Wind))/(max(Wind) - min(Wind)),
           PressDist = (Pressure - max(Pressure))/(max(Pressure) - min(Pressure))) %>%
    gather(Var, Val, WindDist, PressDist) %>% 
    ggplot(aes(x = Date, y = Val, group = Var, color = Var)) + 
    geom_line(size = 1) + 
    scale_color_discrete(labels = c("Pressure Change", "Wind Change")) + 
    theme_bw() + 
    theme(legend.position = "bottom", 
          legend.title = element_blank()) + 
    labs(title = "Wind/Pressure Relational Change", 
         subtitle = "",
         caption = sprintf("rrricanes %s", packageVersion("rrricanes")), 
         y = "")
```

### Wind Radius

```{r, fig.width = 5}
wr_animate <- tidy_wr(fstadv) %>% 
    gather(Quadrant, Radius, NE:NW) %>% 
    ggplot(aes(x = Quadrant, y = Radius, fill = factor(WindField), 
               frame = Adv)) + 
    geom_bar(stat = "identity", position = "identity", width = 1) + 
    guides(fill = guide_legend(title = "Wind Field")) +
    coord_polar() + 
    theme(legend.position = "bottom") + 
    labs(title = "Wind Radius for Advisory", 
         subtitle = "Minimum sustained one-minute wind speed in knots",
         caption = sprintf("rrricanes %s", packageVersion("rrricanes")), 
         y = "Radius (nm)")
```

```{r}
gganimate(wr_animate, "wind_radius.gif", ani.width = 750, ani.height = 750)
```

![](wind_radius.gif)

One of the interesting things to note about the image above; Hurricane Ike was known for it's very large wind field (relatively speaking) which generated a larger and wider storm surge than normal for it's classification. You can see this very well defined structure expansion between advisories 38 and 42. 

This, in part, led to the modification of the Saffir Simpson Hurricane Scale. 

> the very large Hurricane Ike (with hurricane force winds extending as much as 125 mi from the center) in 2008 made landfall in Texas as a Category 2 hurricane and had peak storm surge values of about 20 ft. In contrast, tiny Hurricane Charley (with hurricane force winds extending at most 25 mi from the center) struck Florida in 2004 as a Category 4 hurricane and produced a peak storm surge of only about 7 ft. These storm surge values were substantially outside of the ranges suggested in the original scale. Thus to help reduce public confusion about the impacts associated with the various hurricane categories as well as to provide a more scientifically defensible scale, the storm surge ranges, flooding impact and central pressure statements are being removed from the scale and only peak winds are employed in this revised version – the Saffir-Simpson Hurricane Wind Scale. [@sshws]

## References
